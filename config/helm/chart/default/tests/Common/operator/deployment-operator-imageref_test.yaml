suite: test deployment for dynatrace operator refimage
chart:
  version: 1.0.0
  appVersion: 1.0.1
templates:
  - Common/operator/deployment-operator.yaml
tests:
  - it: should run the same if image is set
    set:
      platform: kubernetes
      image: image-name
    asserts:
      - equal:
          path: spec.template.spec
          value:
            containers:
              - name: RELEASE-NAME
                args:
                  - operator
                # Replace this with the built image name
                image: image-name
                imagePullPolicy: Always
                env:
                  - name: POD_NAMESPACE
                    valueFrom:
                      fieldRef:
                        fieldPath: metadata.namespace
                  - name: POD_NAME
                    valueFrom:
                      fieldRef:
                        fieldPath: metadata.name
                ports:
                  - containerPort: 10080
                    name: server-port
                resources:
                  requests:
                    cpu: 50m
                    memory: 64Mi
                  limits:
                    cpu: 100m
                    memory: 128Mi
                volumeMounts:
                  - name: tmp-cert-dir
                    mountPath: /tmp/dynatrace-operator
                readinessProbe:
                  httpGet:
                    path: /livez
                    port: server-port
                    scheme: HTTP
                  initialDelaySeconds: 15
                  periodSeconds: 10
                livenessProbe:
                  httpGet:
                    path: /livez
                    port: server-port
                    scheme: HTTP
                  initialDelaySeconds: 15
                  periodSeconds: 10
                securityContext:
                  seccompProfile:
                    type: RuntimeDefault
                  privileged: false
                  allowPrivilegeEscalation: false
                  readOnlyRootFilesystem: true
                  runAsNonRoot: true
                  runAsUser: 1001
                  runAsGroup: 1001
                  capabilities:
                    drop:
                      - ALL
            affinity:
              nodeAffinity:
                requiredDuringSchedulingIgnoredDuringExecution:
                  nodeSelectorTerms:
                    - matchExpressions:
                        - key: kubernetes.io/arch
                          operator: In
                          values:
                            - amd64
                            - arm64
                        - key: kubernetes.io/os
                          operator: In
                          values:
                            - linux
            volumes:
              - emptyDir: { }
                name: tmp-cert-dir
            serviceAccountName: RELEASE-NAME
            tolerations:
              - effect: NoSchedule
                key: kubernetes.io/arch
                value: arm64
              - effect: NoSchedule
                key: kubernetes.io/arch
                value: amd64

  - it: it uses imageref if set
    set:
      platform: kubernetes
      imageRef:
        repository: some-repo
        tag: tag-name
    asserts:
      - equal:
          path: spec.template.spec
          value:
            containers:
              - name: RELEASE-NAME
                args:
                  - operator
                # Replace this with the built image name
                image: "some-repo:vtag-name"
                imagePullPolicy: Always
                env:
                  - name: POD_NAMESPACE
                    valueFrom:
                      fieldRef:
                        fieldPath: metadata.namespace
                  - name: POD_NAME
                    valueFrom:
                      fieldRef:
                        fieldPath: metadata.name
                ports:
                  - containerPort: 10080
                    name: server-port
                resources:
                  requests:
                    cpu: 50m
                    memory: 64Mi
                  limits:
                    cpu: 100m
                    memory: 128Mi
                volumeMounts:
                  - name: tmp-cert-dir
                    mountPath: /tmp/dynatrace-operator
                readinessProbe:
                  httpGet:
                    path: /livez
                    port: server-port
                    scheme: HTTP
                  initialDelaySeconds: 15
                  periodSeconds: 10
                livenessProbe:
                  httpGet:
                    path: /livez
                    port: server-port
                    scheme: HTTP
                  initialDelaySeconds: 15
                  periodSeconds: 10
                securityContext:
                  seccompProfile:
                    type: RuntimeDefault
                  privileged: false
                  allowPrivilegeEscalation: false
                  readOnlyRootFilesystem: true
                  runAsNonRoot: true
                  runAsUser: 1001
                  runAsGroup: 1001
                  capabilities:
                    drop:
                      - ALL
            affinity:
              nodeAffinity:
                requiredDuringSchedulingIgnoredDuringExecution:
                  nodeSelectorTerms:
                    - matchExpressions:
                        - key: kubernetes.io/arch
                          operator: In
                          values:
                            - amd64
                            - arm64
                        - key: kubernetes.io/os
                          operator: In
                          values:
                            - linux
            volumes:
              - emptyDir: { }
                name: tmp-cert-dir
            serviceAccountName: RELEASE-NAME
            tolerations:
              - effect: NoSchedule
                key: kubernetes.io/arch
                value: arm64
              - effect: NoSchedule
                key: kubernetes.io/arch
                value: amd64

  - it: image tag has precedence over imageref
    set:
      platform: kubernetes
      image: image-name
      imageRef:
        repository: not-the-repo-you-are-looking-for
        tag: tag-name
    asserts:
      - equal:
          path: spec.template.spec
          value:
            containers:
              - name: RELEASE-NAME
                args:
                  - operator
                # Replace this with the built image name
                image: "image-name"
                imagePullPolicy: Always
                env:
                  - name: POD_NAMESPACE
                    valueFrom:
                      fieldRef:
                        fieldPath: metadata.namespace
                  - name: POD_NAME
                    valueFrom:
                      fieldRef:
                        fieldPath: metadata.name
                ports:
                  - containerPort: 10080
                    name: server-port
                resources:
                  requests:
                    cpu: 50m
                    memory: 64Mi
                  limits:
                    cpu: 100m
                    memory: 128Mi
                volumeMounts:
                  - name: tmp-cert-dir
                    mountPath: /tmp/dynatrace-operator
                readinessProbe:
                  httpGet:
                    path: /livez
                    port: server-port
                    scheme: HTTP
                  initialDelaySeconds: 15
                  periodSeconds: 10
                livenessProbe:
                  httpGet:
                    path: /livez
                    port: server-port
                    scheme: HTTP
                  initialDelaySeconds: 15
                  periodSeconds: 10
                securityContext:
                  seccompProfile:
                    type: RuntimeDefault
                  privileged: false
                  allowPrivilegeEscalation: false
                  readOnlyRootFilesystem: true
                  runAsNonRoot: true
                  runAsUser: 1001
                  runAsGroup: 1001
                  capabilities:
                    drop:
                      - ALL
            affinity:
              nodeAffinity:
                requiredDuringSchedulingIgnoredDuringExecution:
                  nodeSelectorTerms:
                    - matchExpressions:
                        - key: kubernetes.io/arch
                          operator: In
                          values:
                            - amd64
                            - arm64
                        - key: kubernetes.io/os
                          operator: In
                          values:
                            - linux
            volumes:
              - emptyDir: { }
                name: tmp-cert-dir
            serviceAccountName: RELEASE-NAME
            tolerations:
              - effect: NoSchedule
                key: kubernetes.io/arch
                value: arm64
              - effect: NoSchedule
                key: kubernetes.io/arch
                value: amd64

  - it: tag in imageref defaults to chart.version
    set:
      platform: kubernetes
      imageRef:
        repository: some-repo

    asserts:
      - equal:
          path: spec.template.specâ‰ˆ
          value:
            containers:
              - name: RELEASE-NAME
                args:
                  - operator
                # Replace this with the built image name
                image: "some-repo:v1.0.1"
                imagePullPolicy: Always
                env:
                  - name: POD_NAMESPACE
                    valueFrom:
                      fieldRef:
                        fieldPath: metadata.namespace
                  - name: POD_NAME
                    valueFrom:
                      fieldRef:
                        fieldPath: metadata.name
                ports:
                  - containerPort: 10080
                    name: server-port
                resources:
                  requests:
                    cpu: 50m
                    memory: 64Mi
                  limits:
                    cpu: 100m
                    memory: 128Mi
                volumeMounts:
                  - name: tmp-cert-dir
                    mountPath: /tmp/dynatrace-operator
                readinessProbe:
                  httpGet:
                    path: /livez
                    port: server-port
                    scheme: HTTP
                  initialDelaySeconds: 15
                  periodSeconds: 10
                livenessProbe:
                  httpGet:
                    path: /livez
                    port: server-port
                    scheme: HTTP
                  initialDelaySeconds: 15
                  periodSeconds: 10
                securityContext:
                  seccompProfile:
                    type: RuntimeDefault
                  privileged: false
                  allowPrivilegeEscalation: false
                  readOnlyRootFilesystem: true
                  runAsNonRoot: true
                  runAsUser: 1001
                  runAsGroup: 1001
                  capabilities:
                    drop:
                      - ALL
            affinity:
              nodeAffinity:
                requiredDuringSchedulingIgnoredDuringExecution:
                  nodeSelectorTerms:
                    - matchExpressions:
                        - key: kubernetes.io/arch
                          operator: In
                          values:
                            - amd64
                            - arm64
                        - key: kubernetes.io/os
                          operator: In
                          values:
                            - linux
            volumes:
              - emptyDir: { }
                name: tmp-cert-dir
            serviceAccountName: RELEASE-NAME
            tolerations:
              - effect: NoSchedule
                key: kubernetes.io/arch
                value: arm64
              - effect: NoSchedule
                key: kubernetes.io/arch
                value: amd64
