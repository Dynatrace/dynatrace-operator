suite: test deployment for csi DaemonSet
templates:
  - Common/csi/daemonset.yaml
tests:
  - it: should not exist by default
    set:
      platform: kubernetes
    asserts:
      - hasDocuments:
          count: 0

  - it: should have tolerations by default
    set:
      platform: kubernetes
      csidriver.enabled: true
    asserts:
    - equal:
        path: spec.template.spec.tolerations
        value:
          - effect: NoSchedule
            key: node-role.kubernetes.io/master
            operator: Exists
          - effect: NoSchedule
            key: node-role.kubernetes.io/control-plane
            operator: Exists

  - it: should have nodeSelectors if set
    set:
      platform: kubernetes
      csidriver.enabled: true
      csidriver.nodeSelector:
        test-key: test-value
    asserts:
    - equal:
        path: spec.template.spec.nodeSelector
        value:
          test-key: test-value

  - it: should exist in case of CSI enabled
    set:
      platform: kubernetes
      image: image-name
      csidriver.enabled: true
    asserts:
      - isKind:
          of: DaemonSet
      - equal:
          path: metadata.name
          value: dynatrace-oneagent-csi-driver
      - equal:
          path: metadata.namespace
          value: NAMESPACE
      - isNotEmpty:
          path: metadata.labels
      - isNotEmpty:
          path: spec.template.metadata.labels

  - it: should create correct spec for template of daemonset spec
    set:
      platform: kubernetes
      image: image-name
      csidriver.enabled: true
    asserts:
      - isNotEmpty:
          path: spec.template.metadata.labels
      - equal:
          path: spec.template.spec
          value:
            priorityClassName: dynatrace-high-priority
            tolerations:
                - effect: NoSchedule
                  key: node-role.kubernetes.io/master
                  operator: Exists
                - effect: NoSchedule
                  key: node-role.kubernetes.io/control-plane
                  operator: Exists
            containers:
              - args:
                  - csi-server
                  - "--endpoint=unix://csi/csi.sock"
                  - "--node-id=$(KUBE_NODE_NAME)"
                  - "--health-probe-bind-address=:10080"
                env:
                  - name: POD_NAMESPACE
                    valueFrom:
                      fieldRef:
                        apiVersion: v1
                        fieldPath: metadata.namespace
                  - name: KUBE_NODE_NAME
                    valueFrom:
                      fieldRef:
                        apiVersion: v1
                        fieldPath: spec.nodeName
                image: image-name
                imagePullPolicy: Always
                livenessProbe:
                  failureThreshold: 3
                  httpGet:
                    path: "/livez"
                    port: livez
                    scheme: HTTP
                  initialDelaySeconds: 5
                  periodSeconds: 5
                  successThreshold: 1
                  timeoutSeconds: 1
                name: server
                ports:
                  - containerPort: 10080
                    name: livez
                    protocol: TCP
                resources:
                  limits:
                    cpu: 150m
                    memory: 100Mi
                  requests:
                    cpu: 150m
                    memory: 100Mi
                securityContext:
                  allowPrivilegeEscalation: true
                  privileged: true
                  readOnlyRootFilesystem: true
                  runAsNonRoot: false
                  runAsUser: 0
                  seLinuxOptions:
                    level: s0
                  seccompProfile:
                    type: RuntimeDefault
                terminationMessagePath: "/dev/termination-log"
                terminationMessagePolicy: File
                volumeMounts:
                  - mountPath: "/csi"
                    name: plugin-dir
                  - mountPath: "/var/lib/kubelet/pods"
                    mountPropagation: Bidirectional
                    name: mountpoint-dir
                  - mountPath: "/data"
                    mountPropagation: Bidirectional
                    name: dynatrace-oneagent-data-dir
                  - mountPath: "/tmp"
                    name: tmp-dir
              - args:
                  - csi-provisioner
                  - "--health-probe-bind-address=:10090"
                env:
                  - name: POD_NAMESPACE
                    valueFrom:
                      fieldRef:
                        apiVersion: v1
                        fieldPath: metadata.namespace
                image: image-name
                imagePullPolicy: Always
                livenessProbe:
                  failureThreshold: 3
                  httpGet:
                    path: "/livez"
                    port: livez
                    scheme: HTTP
                  initialDelaySeconds: 5
                  periodSeconds: 5
                  successThreshold: 1
                  timeoutSeconds: 1
                name: provisioner
                ports:
                  - containerPort: 10090
                    name: livez
                    protocol: TCP
                resources:
                  limits:
                    cpu: 300m
                    memory: 100Mi
                  requests:
                    cpu: 300m
                    memory: 100Mi
                securityContext:
                  allowPrivilegeEscalation: true
                  privileged: true
                  readOnlyRootFilesystem: true
                  runAsNonRoot: false
                  runAsUser: 0
                  seLinuxOptions:
                    level: s0
                  seccompProfile:
                    type: RuntimeDefault
                terminationMessagePath: "/dev/termination-log"
                terminationMessagePolicy: File
                volumeMounts:
                  - mountPath: "/data"
                    mountPropagation: Bidirectional
                    name: dynatrace-oneagent-data-dir
                  - mountPath: "/tmp"
                    name: tmp-dir
              - args:
                  - "--csi-address=/csi/csi.sock"
                  - "--kubelet-registration-path=/var/lib/kubelet/plugins/csi.oneagent.dynatrace.com/csi.sock"
                command:
                  - csi-node-driver-registrar
                image: image-name
                imagePullPolicy: Always
                livenessProbe:
                  exec:
                    command:
                      - csi-node-driver-registrar
                      - "--kubelet-registration-path=/var/lib/kubelet/plugins/csi.oneagent.dynatrace.com/csi.sock"
                      - "--mode=kubelet-registration-probe"
                  failureThreshold: 3
                  initialDelaySeconds: 30
                  periodSeconds: 10
                  successThreshold: 1
                  timeoutSeconds: 15
                name: registrar
                resources:
                  limits:
                    cpu: 100m
                    memory: 100Mi
                  requests:
                    cpu: 10m
                    memory: 20Mi
                securityContext:
                  privileged: false
                  readOnlyRootFilesystem: true
                  runAsNonRoot: false
                  runAsUser: 0
                  seccompProfile:
                    type: RuntimeDefault
                terminationMessagePath: "/dev/termination-log"
                terminationMessagePolicy: File
                volumeMounts:
                  - mountPath: "/csi"
                    name: plugin-dir
                  - mountPath: "/registration"
                    name: registration-dir
                  - mountPath: "/var/lib/kubelet/plugins/csi.oneagent.dynatrace.com"
                    name: lockfile-dir
              - args:
                  - "--csi-address=/csi/csi.sock"
                  - "--health-port=9898"
                command:
                  - livenessprobe
                image: image-name
                imagePullPolicy: Always
                name: liveness-probe
                resources:
                  limits:
                    cpu: 100m
                    memory: 100Mi
                  requests:
                    cpu: 10m
                    memory: 20Mi
                securityContext:
                  allowPrivilegeEscalation: false
                  privileged: false
                  readOnlyRootFilesystem: true
                  runAsNonRoot: false
                  runAsUser: 0
                  seccompProfile:
                    type: RuntimeDefault
                terminationMessagePath: "/dev/termination-log"
                terminationMessagePolicy: File
                volumeMounts:
                  - mountPath: "/csi"
                    name: plugin-dir
            dnsPolicy: ClusterFirst
            restartPolicy: Always
            schedulerName: default-scheduler
            securityContext: { }
            serviceAccountName: dynatrace-oneagent-csi-driver
            terminationGracePeriodSeconds: 30
            volumes:
              - hostPath:
                  path: /var/lib/kubelet/plugins_registry/
                  type: Directory
                name: registration-dir
              - hostPath:
                  path: /var/lib/kubelet/plugins/csi.oneagent.dynatrace.com
                  type: DirectoryOrCreate
                name: plugin-dir
              - hostPath:
                  path: /var/lib/kubelet/pods
                  type: DirectoryOrCreate
                name: mountpoint-dir
              - hostPath:
                  path: /var/lib/kubelet/plugins/csi.oneagent.dynatrace.com/data
                  type: DirectoryOrCreate
                name: dynatrace-oneagent-data-dir
              - emptyDir: { }
                name: lockfile-dir
              - emptyDir: { }
                name: tmp-dir

  - it: should have imagePullSecrets defined in spec
    set:
      platform: kubernetes
      customPullSecret: pull-secret
      csidriver.enabled: true
    asserts:
      - equal:
          path: spec.template.spec.imagePullSecrets[0].name
          value: pull-secret

  - it: should take custom labels
    set:
      platform: kubernetes
      csidriver.enabled: true
      csidriver.labels:
        testKey: testValue
    asserts:
      - isNotEmpty:
          path: metadata.labels.testKey
      - equal:
          path: metadata.labels.testKey
          value: testValue

  - it: should take custom annotations
    set:
      platform: kubernetes
      csidriver.enabled: true
      csidriver.annotations:
        testKey: testValue
    asserts:
      - equal:
          path: spec.template.metadata.annotations
          value:
            kubectl.kubernetes.io/default-logs-container: provisioner
            testKey: testValue

  - it: should take custom labels in spec.template.metadata.labels path
    set:
      platform: kubernetes
      csidriver.enabled: true
      csidriver.labels:
        testKey: testValue
    asserts:
      - isNotEmpty:
          path: spec.template.metadata.labels.testKey
      - equal:
          path: spec.template.metadata.labels.testKey
          value: testValue

  - it: should take resource limits from values file
    set:
      csidriver.enabled: true
      csidriver.requests.cpu: 600m
      csidriver.requests.memory: 200Mi
      csidriver.limits.cpu: 900m
      csidriver.limits.memory: 300Mi
    asserts:
      - equal:
          path: spec.template.spec.containers[1].name
          value: provisioner
      - equal:
          path: spec.template.spec.containers[1].resources.requests.cpu
          value: 600m
      - equal:
          path: spec.template.spec.containers[1].resources.requests.memory
          value: 200Mi
      - equal:
          path: spec.template.spec.containers[1].resources.limits.cpu
          value: 900m
      - equal:
          path: spec.template.spec.containers[1].resources.limits.memory
          value: 300Mi
