suite: test csi driver resource
templates:
  - Common/csi/csidriver.yaml
tests:
  - it: should exist 1 by default
    set:
      platform: kubernetes
    asserts:
      - hasDocuments:
          count: 1

  - it: should be built correctly with CSI enabled
    set:
      platform: kubernetes
      csidriver.enabled: true
    asserts:
      - isAPIVersion:
          of: storage.k8s.io/v1
      - isKind:
          of: CSIDriver
      - equal:
          path: metadata.name
          value: csi.oneagent.dynatrace.com
      - equal:
          path: spec.attachRequired
          value: false
      - equal:
          path: spec.podInfoOnMount
          value: true
      - equal:
          path: spec.volumeLifecycleModes
          value:
            - Ephemeral

  - it: should contain correct labels for openshift with CSI enabled
    set:
      platform: openshift
      csidriver.enabled: true
      partial: false
    asserts:
      - isSubset:
          path: metadata.labels
          content:
            security.openshift.io/csi-ephemeral-volume-profile: "restricted"

  - it: should contain correct labels for openshift manifest
    set:
      platform: openshift
      csidriver.enabled: false
      partial: csi
    asserts:
      - isSubset:
          path: metadata.labels
          content:
            security.openshift.io/csi-ephemeral-volume-profile: "restricted"
