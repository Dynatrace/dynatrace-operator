From: A happy user <happy@example.com>
Date: Mon, 23 Sep 2024 10:54:35 +0200
Subject: [PATCH] Patch to enable debugging of the CSI server

---
 Dockerfile                                           |  2 ++
 .../default/templates/Common/csi/daemonset.yaml      | 12 ++++++++++++
 config/helm/chart/default/values.yaml                |  8 ++++----
 hack/build/create_go_linker_args.sh                  |  2 +-
 4 files changed, 19 insertions(+), 5 deletions(-)

diff --git a/Dockerfile b/Dockerfile
index 00a33234..af6ef4f3 100644
--- a/Dockerfile
+++ b/Dockerfile
@@ -8,6 +8,7 @@ WORKDIR /app

 COPY go.mod go.sum ./
 RUN go mod download -x
+RUN go install github.com/go-delve/delve/cmd/dlv@latest

 ARG GO_LINKER_ARGS
 ARG GO_BUILD_TAGS
@@ -39,6 +40,7 @@ COPY --from=dependency /tmp/rootfs-dependency /

 # operator binary
 COPY --from=operator-build /app/build/_output/bin /usr/local/bin
+COPY --from=operator-build /go/bin/dlv /usr/local/bin

 # csi binaries
 COPY --from=registry.k8s.io/sig-storage/csi-node-driver-registrar:v2.12.0@sha256:0d23a6fd60c421054deec5e6d0405dc3498095a5a597e175236c0692f4adee0f /csi-node-driver-registrar /usr/local/bin
diff --git a/config/helm/chart/default/templates/Common/csi/daemonset.yaml b/config/helm/chart/default/templates/Common/csi/daemonset.yaml
index c24305ed..563cdecc 100644
--- a/config/helm/chart/default/templates/Common/csi/daemonset.yaml
+++ b/config/helm/chart/default/templates/Common/csi/daemonset.yaml
@@ -79,6 +79,18 @@ spec:
       - name: server
         image: {{ include "dynatrace-operator.image" . }}
         imagePullPolicy: Always
+        command:
+          - dlv
+          - --listen=:40000
+          - --headless=true
+          - --api-version=2
+          - --log
+          - exec
+          - --continue
+          - --accept-multiclient
+          - --
+          - /usr/local/bin/dynatrace-operator
+          # kubectl port-forward -n dynatrace $(kubectl get pod -n dynatrace -l app.kubernetes.io/component=csi-driver -o jsonpath='{.items[0].metadata.name}') 40000:40000
         args:
         - csi-server
         - --endpoint=unix://csi/csi.sock
diff --git a/config/helm/chart/default/values.yaml b/config/helm/chart/default/values.yaml
index 144c9e34..b6859356 100644
--- a/config/helm/chart/default/values.yaml
+++ b/config/helm/chart/default/values.yaml
@@ -142,11 +142,11 @@ csidriver:
         type: RuntimeDefault
     resources:
       requests:
-        cpu: 50m
-        memory: 100Mi
+        cpu: 200m
+        memory: 500Mi
       limits:
-        cpu: 50m
-        memory: 100Mi
+        cpu: 200m
+        memory: 500Mi
   provisioner:
     securityContext:
       runAsUser: 0
diff --git a/hack/build/create_go_linker_args.sh b/hack/build/create_go_linker_args.sh
index e497a1de..b186d2a1 100755
--- a/hack/build/create_go_linker_args.sh
+++ b/hack/build/create_go_linker_args.sh
@@ -14,6 +14,6 @@ go_linker_args=(
   "-X 'github.com/Dynatrace/dynatrace-operator/pkg/version.Version=${version}'"
   "-X 'github.com/Dynatrace/dynatrace-operator/pkg/version.Commit=${commit}'"
   "-X 'github.com/Dynatrace/dynatrace-operator/pkg/version.BuildDate=${build_date}'"
-  "-extldflags=-static -s -w"
+  "-extldflags=-static"
 )
 echo "${go_linker_args[*]}"
--
2.39.5 (Apple Git-154)

