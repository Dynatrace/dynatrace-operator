From: A happy user <happy@example.com>
Date: Thu, 26 Sep 2024 10:06:58 +0200
Subject: [PATCH] [PATCH] Patch to enable debugging of the CSI provisioner

---
 Dockerfile                                            |  2 ++
 .../chart/default/templates/Common/csi/daemonset.yaml | 11 +++++++++++
 config/helm/chart/default/values.yaml                 |  2 +-
 hack/build/create_go_linker_args.sh                   |  2 +-
 4 files changed, 15 insertions(+), 2 deletions(-)

diff --git a/Dockerfile b/Dockerfile
index b470adb0..7e39aed0 100644
--- a/Dockerfile
+++ b/Dockerfile
@@ -8,6 +8,7 @@ WORKDIR /app

 COPY go.mod go.sum ./
 RUN go mod download -x
+RUN go install github.com/go-delve/delve/cmd/dlv@latest

 ARG GO_LINKER_ARGS
 ARG GO_BUILD_TAGS
@@ -39,6 +40,7 @@ COPY --from=dependency /tmp/rootfs-dependency /

 # operator binary
 COPY --from=operator-build /app/build/_output/bin /usr/local/bin
+COPY --from=operator-build /go/bin/dlv /usr/local/bin

 # csi binaries
 COPY --from=registry.k8s.io/sig-storage/csi-node-driver-registrar:v2.12.0@sha256:0d23a6fd60c421054deec5e6d0405dc3498095a5a597e175236c0692f4adee0f /csi-node-driver-registrar /usr/local/bin
diff --git a/config/helm/chart/default/templates/Common/csi/daemonset.yaml b/config/helm/chart/default/templates/Common/csi/daemonset.yaml
index c24305ed..b24f6104 100644
--- a/config/helm/chart/default/templates/Common/csi/daemonset.yaml
+++ b/config/helm/chart/default/templates/Common/csi/daemonset.yaml
@@ -131,6 +131,17 @@ spec:
       - name: provisioner
         image: {{ include "dynatrace-operator.image" . }}
         imagePullPolicy: Always
+        command:
+          - dlv
+          - --listen=:40000
+          - --headless=true
+          - --api-version=2
+          - --log
+          - exec
+          - --continue
+          - --accept-multiclient
+          - --
+          - /usr/local/bin/dynatrace-operator
         args:
           - csi-provisioner
           - --health-probe-bind-address=:10090
diff --git a/config/helm/chart/default/values.yaml b/config/helm/chart/default/values.yaml
index 144c9e34..b03fe550 100644
--- a/config/helm/chart/default/values.yaml
+++ b/config/helm/chart/default/values.yaml
@@ -161,7 +161,7 @@ csidriver:
     resources:
       requests:
         cpu: 300m
-        memory: 100Mi
+        memory: 500Mi
   registrar:
     securityContext:
       runAsUser: 0
diff --git a/hack/build/create_go_linker_args.sh b/hack/build/create_go_linker_args.sh
index e497a1de..b186d2a1 100755
--- a/hack/build/create_go_linker_args.sh
+++ b/hack/build/create_go_linker_args.sh
@@ -14,6 +14,6 @@ go_linker_args=(
   "-X 'github.com/Dynatrace/dynatrace-operator/pkg/version.Version=${version}'"
   "-X 'github.com/Dynatrace/dynatrace-operator/pkg/version.Commit=${commit}'"
   "-X 'github.com/Dynatrace/dynatrace-operator/pkg/version.BuildDate=${build_date}'"
-  "-extldflags=-static -s -w"
+  "-extldflags=-static"
 )
 echo "${go_linker_args[*]}"
--
2.39.5 (Apple Git-154)

