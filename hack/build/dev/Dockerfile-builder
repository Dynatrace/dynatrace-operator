FROM golang:1.19.3-alpine

RUN apk update --no-cache && \
    apk add --no-cache gcc musl-dev btrfs-progs-dev lvm2-dev device-mapper-static gpgme-dev git && \
    rm -rf /var/cache/apk/*

ADD ./go.mod /app/go.mod
RUN cd /app && go mod download

ENV CGO_ENABLED=1
ENV CGO_CFLAGS="-O0 -Wno-return-local-addr"

CMD cd /in; go build -ldflags="${GO_LINKER_ARGS}" -buildvcs=false -o /out/build/_output/bin/dynatrace-operator /in/src/cmd/
