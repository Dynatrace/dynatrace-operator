name: Run e2e tests
description: Runs the e2e test in the specified environment
inputs:
  flc-namespace:
    description: The namespace FLC uses
    required: true
  flc-environment:
    description: The environment FLC uses
    required: true

runs:
  using: composite
  steps:
    - name: Checkout workflow scripts from ref branch
      uses: actions/checkout@a5ac7e51b41094c92402da3b24376905380afc29 # v4.1.6
      with:
        path: ref
    - name: Checkout target branch
      uses: actions/checkout@a5ac7e51b41094c92402da3b24376905380afc29 # v4.1.6
      with:
        ref: ${{ github.event.inputs.target || 'main' }}
        path: target
    - name: Set up kubectl
      uses: azure/setup-kubectl@3e0aec4d80787158d308d7b364cb1b702e7feb7f # v4.0.0
    - name: Set up go
      uses: actions/setup-go@cdcb36043654635271a94b9a6d1392de5bb323a7 # v5.0.1
      with:
        go-version-file: "${{ github.workspace }}/target/go.mod"
    - name: Set up helm
      uses: azure/setup-helm@fe7b79cd5ee1e45176fcad797de68ecaf3ca4814 # v4.2.0
      with:
        token: ${{ inputs.github-token }}
    - name: Install gotestsum
      shell: bash
      run: go install gotest.tools/gotestsum@latest
    - name: Create cluster
      shell: bash
      run: ref/.github/scripts/create-cluster.sh
      env:
        FLC_NAMESPACE: ${{ inputs.flc-namespace }}
        FLC_ENVIRONMENT: ${{ inputs.flc-environment }}
    - name: Run tests
      shell: bash
      run: ref/.github/scripts/run-e2e-tests.sh
      env:
        FLC_NAMESPACE: ${{ inputs.flc-namespace }}
        FLC_ENVIRONMENT: ${{ inputs.flc-environment }}
        TARGET_BRANCH: ${{ github.event.inputs.target }}
        TENANT1_NAME: ${{ secrets.TENANT1_NAME }}
        TENANT1_APITOKEN: ${{ secrets.TENANT1_APITOKEN }}
        TENANT1_OTELTOKEN: ${{ secrets.TENANT1_OTELTOKEN }}
        TENANT1_OAUTH_CLIENT_ID: ${{ secrets.TENANT1_OAUTH_CLIENT_ID }}
        TENANT1_OAUTH_SECRET: ${{ secrets.TENANT1_OAUTH_SECRET }}
        TENANT2_NAME: ${{ secrets.TENANT2_NAME }}
        TENANT2_APITOKEN: ${{ secrets.TENANT2_APITOKEN }}
    - name: Destroy cluster
      shell: bash
      run: ref/.github/scripts/destroy-cluster.sh
      env:
        FLC_NAMESPACE: ${{ inputs.flc-namespace }}
        FLC_ENVIRONMENT: ${{ inputs.flc-environment }}
      if: always()
    - name: Publish test results
      uses: EnricoMi/publish-unit-test-result-action@v2
      with:
        files: target/results/*.xml
      if: always()
