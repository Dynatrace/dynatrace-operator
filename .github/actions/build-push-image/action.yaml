name: Build and Push Docker Image
description: Builds and pushes the operator docker image
inputs:
  platforms:
    description: The platforms for which the image will be built
    default: linux/amd64,linux/arm64
    required: true
  annotation:
    description: The annotation added to the built image
    required: false
  dockerfile:
    description: The path to the Dockerfile to be used
    default: ./Dockerfile
  images:
    description: Base names of the image tags
    required: false
  suffix:
    description: Suffix appended to image tags
    required: false
outputs:
  digest:
    description: The digest of the built image
    value: ${{ steps.build-target.outputs.digest }}
runs:
  using: "composite"
  steps:
    - name: Build image metadata
      uses: ./.github/actions/metadata
      id: meta
      with:
        platforms: ${{ inputs.platforms }}
        annotation: ${{ inputs.annotation }}
        images: ${{ inputs.images }}
        suffix: ${{ inputs.suffix }}
    - name: Set up QEMU
      uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0
    - name: Set up Golang
      uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
      with:
        go-version: 'stable' # Latest stable version
        cache: false
    - name: Download third party licenses
      shell: bash
      run: |
        hack/build/ci/third-party-licenses.sh
    - name: Prepare linker args
      id: linker-args
      shell: bash
      env:
        GITHUB_SHA: ${{ github.sha }}
        TAG_NAMES: ${{ steps.meta.outputs.tag-names }}
      run: |
        # Only pass the first tag to create_go_linker_args.sh
        tag=$(echo "${TAG_NAMES}" | head -n 1)
        go_linker_args=$(hack/build/create_go_linker_args.sh "${tag}" "${GITHUB_SHA}")
        echo "go_linker_args=${go_linker_args}" >> $GITHUB_OUTPUT
    - name: Build target
      id: build-target
      uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
      with:
        builder: ${{ steps.buildx.outputs.name }}
        build-args: |
          GO_LINKER_ARGS=${{ steps.linker-args.outputs.go_linker_args }}
        context: .
        file: ${{ inputs.dockerfile }}
        provenance: false
        platforms: ${{ inputs.platforms }}
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: |
          ${{ steps.meta.outputs.labels }}
        annotations: |
          ${{ steps.meta.outputs.annotations }}

