name: Upload helm package
description: Upload the helm package
inputs:
  registry-url:
    description: URL for the OCI registry
    required: true
    default: registry.hub.docker.com
  registry-namespace:
    description: Repository in the OCI registry
    required: true
    default: dynatrace
  image-base-url:
    description: Base URL for the image
    required: true
    default: docker.io
  helm-repository-name:
    description: Repository used in the OCI registry, be aware that helm upload does infer this from the helm package name itself
    required: true
    default: dynatrace-operator
  version:
    description: The version of the helm package to upload
    required: true
  version-without-prefix:
    description: The version of the helm package to upload without the leading 'v' character
    required: true
  cosign-private-key:
    description: Private key used to sign the helm package
    required: true
  cosign-password:
    description: Password used to encrypt the private key
    required: true
  upload-nightly:
    description: Whether a nightly helm package should be uploaded
    required: false
    default: 'false'
  mutable-nightly-tag:
    description: Image tag pointing to the mutable (latest) nightly build
    required: false
    default: '0.0.0-nightly-chart'

runs:
  using: "composite"
  steps:
  - name: Upload helm package to OCI registry
    id: push-helm-to-OCI
    if: ${{ inputs.upload-nightly != 'true' }}
    shell: bash
    run: |
        hack/build/ci/push-helm-chart.sh \
        "./helm-pkg/dynatrace-operator-${{ inputs.version-without-prefix }}.tgz" \
        "oci://${{ inputs.registry-url }}/${{ inputs.registry-namespace }}"
  - name: Install ORAS
    uses: oras-project/setup-oras@8d34698a59f5ffe24821f0b48ab62a3de8b64b20 # v1.2.3
    if: ${{ inputs.upload-nightly == 'true' }}
  - name: Upload nightly helm package to OCI registry
    id: push-nightly-helm-to-OCI
    if: ${{ inputs.upload-nightly == 'true' }}
    env:
      HELM_CONFIG_FILE: ${{ runner.temp }}/config.json
      IMAGE_VERSION: ${{ inputs.version }}
      PATH_TO_HELM_CHART: helm-pkg/dynatrace-operator-${{ inputs.version-without-prefix }}.tgz
      REGISTRY_URL: ${{ inputs.registry-url }}/${{ inputs.registry-namespace }}
      REPOSITORY_NAME: ${{ inputs.helm-repository-name }}
    shell: bash
    run: |
      hack/build/ci/push-nightly-helm-chart.sh
  - name: Sign OCI package with cosign
    uses: ./.github/actions/sign-image
    with:
      image: "${{ inputs.image-base-url }}/${{ inputs.registry-namespace }}/${{ inputs.helm-repository-name }}:${{ inputs.version }}@${{ steps.push-helm-to-OCI.outputs.digest }}"
      signing-key: ${{ inputs.cosign-private-key }}
      signing-password: ${{ inputs.cosign-password }}
  - name: Create mutable nightly tag
    if: ${{ inputs.upload-nightly == 'true' }}
    env:
      MANIFEST_DIGEST: ${{ steps.push-nightly-helm-to-OCI.outputs.digest }}
      MUTABLE_NIGHTLY_TAG: ${{ inputs.mutable-nightly-tag }}
      REGISTRY_URL: ${{ inputs.registry-url }}/${{ inputs.registry-namespace }}
      REPOSITORY_NAME: ${{ inputs.helm-repository-name }}
    shell: bash
    run: |
      oras tag "${REGISTRY_URL}/${REPOSITORY_NAME}@${MANIFEST_DIGEST}" "${MUTABLE_NIGHTLY_TAG}"
