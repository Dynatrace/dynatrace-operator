name: "Update CSV bundles"
description: "Generate and finalize OLM CSV bundles for a given version"

inputs:
  version:
    description: "Version without v-prefix"
    required: true
  token:
    description: "GitHub token to create PRs"
    required: true
  changelog-path:
    description: "Path to the changelog file"
    required: false

outputs:
  major_minor:
    description: "Major.minor part of the version"
    value: ${{ steps.vars.outputs.major_minor }}

runs:
  using: "composite"
  steps:
    - name: Derive release branch name
      id: vars
      shell: bash
      run: |
        VERSION="${{ inputs.version }}"

        MAJOR_MINOR="${VERSION%.*}"
        echo "major_minor=${MAJOR_MINOR}" >> "$GITHUB_OUTPUT"
    - name: Checkout release branch
      uses: actions/checkout@v4
      with:
        ref: release-${{ steps.vars.outputs.major_minor }}
        fetch-depth: 0
    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version-file: "${{ github.workspace }}/go.mod"
    - name: Setting properties
      shell: bash
      env:
        CHANGELOG_CONTENT: ${{ inputs.changelog-path }}
        DIGEST: ${{ inputs.digest }}
        VERSION: ${{ inputs.version }}
      run: |
        VERSION="${VERSION}"

        echo "Setting version to v${VERSION} in files"
        ./.github/scripts/set_property.py --file "config/helm/chart/default/Chart.yaml" --property "appVersion" --value "v${VERSION}" 
        ./.github/scripts/set_property.py --file "config/helm/chart/default/Chart.yaml" --property "version" --value "${VERSION}"

        cat <<EOF > "config/helm/chart/default/Chart.yaml.tmp"
        # Copyright 2020 Dynatrace LLC
        # Licensed under the Apache License, Version 2.0 (the "License");
        # you may not use this file except in compliance with the License.
        # You may obtain a copy of the License at
        #     http://www.apache.org/licenses/LICENSE-2.0
        # Unless required by applicable law or agreed to in writing, software
        # distributed under the License is distributed on an "AS IS" BASIS,
        # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
        # See the License for the specific language governing permissions and
        # limitations under the License.
        EOF

        cat "config/helm/chart/default/Chart.yaml" >> "config/helm/chart/default/Chart.yaml.tmp"
        mv "config/helm/chart/default/Chart.yaml.tmp" "config/helm/chart/default/Chart.yaml"

        echo "Setting version in schema.yaml"
        ./.github/scripts/set_property.py \
          --file "config/helm/schema.yaml" \
          --property "x-google-marketplace.publishedVersion" \
          --value "${VERSION}"

        echo "Setting changelog in schema.yaml"
        ./.github/scripts/set_property.py \
          --file "config/helm/schema.yaml" \
          --property "x-google-marketplace.publishedVersionMetadata.releaseNote" \
          --value-from-file "${CHANGELOG_CONTENT}"

        echo "Adding copyright notice to schema.yaml"
        cat <<EOF > "config/helm/schema.yaml.tmp"
        # Copyright 2020 Dynatrace LLC
        # Licensed under the Apache License, Version 2.0 (the "License");
        # you may not use this file except in compliance with the License.
        # You may obtain a copy of the License at
        #     http://www.apache.org/licenses/LICENSE-2.0
        # Unless required by applicable law or agreed to in writing, software
        # distributed under the License is distributed on an "AS IS" BASIS,
        # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
        # See the License for the specific language governing permissions and
        # limitations under the License.
        EOF

        cat "config/helm/schema.yaml" >> "config/helm/schema.yaml.tmp"
        mv "config/helm/schema.yaml.tmp" "config/helm/schema.yaml"

        echo "Setting version in application.yaml"
        sed -i \
          "s/    version: \"[0-9]+\.[0-9]+\.[0-9]+\"/    version: \"${VERSION}\"/" \
          "config/helm/chart/default/templates/application.yaml"
    - name: Install operator-sdk v1.36.0
      shell: bash
      env:
        VERSION: ${{ inputs.version }}
      run: |
        GOBIN="$(go env GOPATH)/bin"
        mkdir -p "$GOBIN"

        echo "Installing operator-sdk v1.36.0 into $GOBIN"
        curl -OJL \
          "https://github.com/operator-framework/operator-sdk/releases/download/v1.36.0/operator-sdk_linux_amd64"
        chmod +x operator-sdk_linux_amd64

        mv operator-sdk_linux_amd64  ${GOBIN}/operator-sdk
        "${GOBIN}/operator-sdk" version

        echo "GOBIN=$GOBIN" >> $GITHUB_ENV
    - name: Generate OLM bundles (openshift)
      shell: bash
      env:
        VERSION: ${{ inputs.version }}
      run: |
        VERSION="${VERSION}"
        mkdir -p config/olm/openshift/bases
        make bundle PLATFORM=openshift VERSION="${VERSION}" CHANNELS=stable DEFAULT_CHANNEL=stable OLM_IMAGE="registry.connect.redhat.com/dynatrace/dynatrace-operator:v${VERSION}" IMAGE="registry.connect.redhat.com/dynatrace/dynatrace-operator"
    - name: Generate OLM bundles (kubernetes)
      shell: bash
      env:
        VERSION: ${{ inputs.version }}
      run: |
        VERSION="${VERSION}"
        make bundle PLATFORM=kubernetes VERSION="${VERSION}" CHANNELS=stable DEFAULT_CHANNEL=stable IMAGE="docker.io/dynatrace/dynatrace-operator" OLM_IMAGE="docker.io/dynatrace/dynatrace-operator:v${VERSION}"
    - name: Finalize CSV files
      shell: bash
      env:
        VERSION: ${{ inputs.version }}
      run: |
        VERSION="${VERSION}"

        echo "Finalizing CSV files for Kubernetes"
        ./.github/scripts/finalize_csv_files.py \
          --platform "kubernetes" \
          --version "${VERSION}" \
          --changelog "${{ inputs.changelog-path }}" \
          --token "${GITHUB_TOKEN}"

        echo "Finalizing CSV files for Openshift"
        ./.github/scripts/finalize_csv_files.py \
          --platform "openshift" \
          --version "${VERSION}" \
          --changelog "${{ inputs.changelog-path }}" \
          --token "${GITHUB_TOKEN}"

    - name: Create CSV update PR
      uses: peter-evans/create-pull-request@v7
      env:
        VERSION: ${{ inputs.version }}
      with:
        base: release-${{ steps.vars.outputs.major_minor }}
        branch: csv-${{ steps.vars.outputs.major_minor}}
        delete-branch: true
        add-paths: |
          config/olm/**
          config/deploy/kubernetes/kustomization.yaml
          config/deploy/openshift/kustomization.yaml
          config/manifests/bases/**
          config/helm/**
        commit-message: "chore: update OLM bundles for v${{ env.VERSION }}"
        signoff: true
        title: "Update OLM CSV bundles for v${{ env.VERSION }}"
        body: |
            This PR updates the OLM bundles/CSVs on `release-${{ steps.vars.outputs.major_minor }}` for version `v${{ env.VERSION }}`.