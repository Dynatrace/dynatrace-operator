name: Create forks for marketplaces

on:
  pull_request:
    types: closed
    branches:
      - release-*
jobs:
  create-forks:
    if: >
      github.event.pull_request.merged == true &&
      startsWith(github.event.pull_request.head.ref, 'csv-') &&
      startsWith(github.event.pull_request.base.ref, 'release-')
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        include:
          - marketplace: community
            original_repo: k8s-operatorhub/community-operators
            fork_repo: dt-team-kubernetes/community-operators
          - marketplace: community-prod
            original_repo: redhat-openshift-ecosystem/community-operators-prod
            fork_repo: dt-team-kubernetes/community-operators-prod
          - marketplace: certified
            original_repo: redhat-openshift-ecosystem/certified-operators
            fork_repo: dt-team-kubernetes/certified-operators
          - marketplace: redhat
            original_repo: redhat-openshift-ecosystem/redhat-marketplace-operators
            fork_repo: dt-team-kubernetes/redhat-marketplace-operators
    env:
      ORIGINAL_REPOSITORY_URL: ${{ matrix.original_repo }}
      FORK_REPOSITORY_URL: ${{ matrix.fork_repo }}
      MARKETPLACE: ${{ matrix.marketplace }}
    steps:
      - name: Checkout dynatrace-operator at base branch (team user)
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ github.event.pull_request.base.ref }}
          fetch-depth: 0
          token: ${{ secrets.TEAM_USER_TOKEN }}
      - name: Configure git identity
        run: |
          git config --global user.name  "${{ secrets.TEAM_USER_NAME }}"
          git config --global user.email "${{ secrets.TEAM_USER_EMAIL }}"
      - name: Install Python deps
        run: |
          pip install -r hack/requirements.txt
      - name: Derive version and branch name
        id: meta
        run: |
          set -euo pipefail
          base_ref='${{ github.event.pull_request.base.ref }}'
          echo "Base ref: $base_ref"

          versions_dirs="$(ls -d config/olm/kubernetes/*/ 2>/dev/null || true)"
          if [ -z "$versions_dirs" ]; then
            echo "ERROR: No bundle directories found under config/olm/kubernetes"
            ls -R config/olm || true
            exit 1
          fi

          version="$(python .github/scripts/release/directory_version.py "${versions_dirs}")"
          echo "Detected bundle version: $version"
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "branch=$base_ref" >> "$GITHUB_OUTPUT"
      - name: Clone and setup fork repository
        env:
          VERSION: ${{ steps.meta.outputs.version }}
          TEAM_TOKEN: ${{ secrets.TEAM_USER_TOKEN }}
        run: |
          set -euo pipefail
          
          fork_clone_url="https://github.com/${FORK_REPOSITORY_URL}.git"
          fork_clone_url_with_token="${fork_clone_url/https:\/\//https:\/\/x-access-token:${TEAM_TOKEN}@}"
          
          echo "Cloning fork ${FORK_REPOSITORY_URL}"
          git clone "${fork_clone_url_with_token}" fork-repo
          cd fork-repo
          
          upstream_repo="${ORIGINAL_REPOSITORY_URL}"
          git remote add upstream "https://github.com/${upstream_repo}.git" || true
          git fetch upstream
          
          branch_name="dynatrace-operator-${VERSION}"
          git checkout -B "${branch_name}" "upstream/main"
          
          echo "FORK_REPO_DIR=$(pwd)" >> "$GITHUB_ENV"
          echo "BRANCH_NAME=${branch_name}" >> "$GITHUB_ENV"
      - name: Prepare bundle files for ${{ env.MARKETPLACE }}
        env:
          VERSION: ${{ steps.meta.outputs.version }}
        run: |
          set -euo pipefail
          cd "${FORK_REPO_DIR}"
          
          # Determine bundle source (kubernetes for community, openshift for others)
          if [ "${MARKETPLACE}" = "community" ]; then
            bundle_source="kubernetes"
          else
            bundle_source="openshift"
          fi
          
          # Setup operator directory
          if [ "${MARKETPLACE}" = "redhat" ]; then
            operator_dir="operators/dynatrace-operator-rhmp/${VERSION}"
          else
            operator_dir="operators/dynatrace-operator/${VERSION}"
          fi
          
          mkdir -p "${operator_dir}/manifests"
          mkdir -p "${operator_dir}/metadata"
          
          # Copy bundle files
          cp -rf "../config/olm/${bundle_source}/${VERSION}/manifests" "${operator_dir}/"
          cp -rf "../config/olm/${bundle_source}/${VERSION}/metadata" "${operator_dir}/"
          
          # Create Dockerfile for community marketplaces
          if [ "${MARKETPLACE}" = "community" ] || [ "${MARKETPLACE}" = "community-prod" ]; then
            echo "Creating Dockerfile for ${MARKETPLACE}"
            origin_dockerfile="../config/olm/kubernetes/bundle-${VERSION}.Dockerfile"
            target_dockerfile="${operator_dir}/Dockerfile"
            sed -n "\|COPY ${VERSION}/manifests /manifests/|q;p" "${origin_dockerfile}" > "${target_dockerfile}"
            echo "COPY manifests /manifests/" >> "${target_dockerfile}"
            echo "COPY metadata /metadata/" >> "${target_dockerfile}"
          fi
          
          # Update package annotation for redhat
          if [ "${MARKETPLACE}" = "redhat" ]; then
            sed -i \
              "s/  operators.operatorframework.io.bundle.package.v1: dynatrace-operator/  operators.operatorframework.io.bundle.package.v1: dynatrace-operator-rhmp/" \
              "${operator_dir}/metadata/annotations.yaml"
          fi
          
          # Determine last existing version and set spec.replaces
          if [ "${MARKETPLACE}" = "redhat" ]; then
            last_version="$(python ../.github/scripts/release/directory_version.py "$(ls -d operators/dynatrace-operator-rhmp/*/)" 2>/dev/null || true)"
          else
            last_version="$(python ../.github/scripts/release/directory_version.py "$(ls -d operators/dynatrace-operator/*/)" 2>/dev/null || true)"
          fi
          
          csv_file="${operator_dir}/manifests/dynatrace-operator.clusterserviceversion.yaml"
          
          if [ -n "${last_version}" ]; then
            if [ "${MARKETPLACE}" = "redhat" ]; then
              yq -i ".spec.replaces = \"dynatrace-operator-rhmp.v${last_version}\"" "${csv_file}"
            else
              yq -i ".spec.replaces = \"dynatrace-operator.v${last_version}\"" "${csv_file}"
            fi
          else
            yq e -i 'del(.spec.replaces)' "${csv_file}"
          fi
      - name: Set IMAGE and prepare CSVs for ${{ env.MARKETPLACE }}
        env:
          VERSION: ${{ steps.meta.outputs.version }}
          RHCC_USERNAME: ${{ secrets.RHCC_USERNAME }}
          RHCC_PASSWORD: ${{ secrets.RHCC_PASSWORD }}
        run: |
          set -euo pipefail
          cd "${FORK_REPO_DIR}"
          
          # Set IMAGE based on marketplace
          case "${MARKETPLACE}" in
            community)
              image_digest=$(skopeo inspect "docker://docker.io/dynatrace/dynatrace-operator:v${VERSION}" | jq -r '.Digest')
              IMAGE="docker.io/dynatrace/dynatrace-operator@${image_digest}"
              ;;
            community-prod)
              image_digest=$(skopeo inspect --username "${RHCC_USERNAME}" --password "${RHCC_PASSWORD}" "docker://registry.connect.redhat.com/dynatrace/dynatrace-operator:v${VERSION}" | jq -r '.Digest')
              IMAGE="registry.connect.redhat.com/dynatrace/dynatrace-operator@${image_digest}"
              ;;
            certified)
              image_digest=$(skopeo inspect --username "${RHCC_USERNAME}" --password "${RHCC_PASSWORD}" "docker://registry.connect.redhat.com/dynatrace/dynatrace-operator:v${VERSION}" | jq -r '.Digest')
              IMAGE="registry.connect.redhat.com/dynatrace/dynatrace-operator@${image_digest}"
              ;;
            redhat)
              image_digest=$(skopeo inspect --username "${RHCC_USERNAME}" --password "${RHCC_PASSWORD}" "docker://registry.connect.redhat.com/dynatrace/dynatrace-operator:v${VERSION}" | jq -r '.Digest')
              IMAGE="registry.connect.redhat.com/dynatrace/dynatrace-operator@${image_digest}"
              ;;
            *)
              echo "Unknown marketplace: ${MARKETPLACE}"
              exit 1
              ;;
          esac
          
          # Prepare CSV files
          if [ "${MARKETPLACE}" = "redhat" ]; then
            csv_file="operators/dynatrace-operator-rhmp/${VERSION}/manifests/dynatrace-operator.clusterserviceversion.yaml"
            python ../.github/scripts/release/csv/make_release_csv.py \
              "${csv_file}" \
              --image "${IMAGE}" \
              --marketplace "${MARKETPLACE}" \
              --isRHCC true
          else
            csv_file="operators/dynatrace-operator/${VERSION}/manifests/dynatrace-operator.clusterserviceversion.yaml"
            python ../.github/scripts/release/csv/make_release_csv.py \
              "${csv_file}" \
              --image "${IMAGE}" \
              --marketplace "${MARKETPLACE}"
          fi
      - name: Post-process CSV for redhat marketplace
        if: matrix.marketplace == 'redhat'
        env:
          VERSION: ${{ steps.meta.outputs.version }}
        run: |
          cd "${FORK_REPO_DIR}"
          
          # Rename CSV file
          mv "operators/dynatrace-operator-rhmp/${VERSION}/manifests/dynatrace-operator.clusterserviceversion.yaml" \
             "operators/dynatrace-operator-rhmp/${VERSION}/manifests/dynatrace-operator-rhmp.clusterserviceversion.yaml"
          
          # Update metadata.name
          yq -i \
            ".metadata.name = \"dynatrace-operator-rhmp.v${VERSION}\"" \
            "operators/dynatrace-operator-rhmp/${VERSION}/manifests/dynatrace-operator-rhmp.clusterserviceversion.yaml"
      - name: Push changes to fork branch
        env:
          VERSION: ${{ steps.meta.outputs.version }}
        run: |
          cd "${FORK_REPO_DIR}"
          
          git add -A
          if git diff-index --quiet HEAD; then
            echo "No changes to commit; nothing to push for ${MARKETPLACE}."
            exit 0
          fi
          
          if [ "${MARKETPLACE}" = "redhat" ]; then
            operator_name="dynatrace-operator-rhmp"
          else
            operator_name="dynatrace-operator"
          fi
          
          git commit -s -m "operator ${operator_name} (${VERSION})"
          git push origin "${BRANCH_NAME}"
