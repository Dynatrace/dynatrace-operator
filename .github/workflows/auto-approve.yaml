name: Auto-approve Renovate PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write
  checks: read
  actions: read

jobs:
  auto-approve:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Only target safe updates from Renovate
    if: >
      github.event.pull_request.user.login == 'renovate[bot]'
    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      # CRUCIAL: Wait for CI checks to complete first
      - name: Wait for CI checks to complete
        uses: lewagon/wait-on-check-action@3603e826ee561ea102b58accb5ea55a1a7482343
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 30
          running-workflow-name: 'auto-approve'

      # Only approve if CI passes
      - name: Approve PR and enable auto-merge
        if: success()
        run: |
          # Approve the PR
          gh pr review --approve ${{ github.event.pull_request.number }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
