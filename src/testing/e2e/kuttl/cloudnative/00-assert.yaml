apiVersion: kuttl.dev/v1beta1
kind: TestAssert
timeout: 30
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: dynakubes.dynatrace.com
spec:
  conversion:
    strategy: Webhook
    webhook:
      clientConfig:
        service:
          namespace: dynatrace
          name: dynatrace-webhook
          path: /convert
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dynatrace-operator
  namespace: dynatrace
  labels:
    dynatrace: operator
    operator: dynakube
spec:
  replicas: 1
  revisionHistoryLimit: 1
  selector:
    matchLabels:
      name: dynatrace-operator
  strategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        name: dynatrace-operator
        dynatrace: operator
        operator: dynakube
    spec:
      serviceAccountName: dynatrace-operator
status:
  availableReplicas: 1
  readyReplicas: 1
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  labels:
    dynatrace.com/operator: dynatrace
  name: dynatrace-oneagent-csi-driver
  namespace: dynatrace
spec:
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      internal.oneagent.dynatrace.com/app: csi-driver
      internal.oneagent.dynatrace.com/component: csi-driver
  template:
    metadata:
      annotations:
        kubectl.kubernetes.io/default-container: driver
      labels:
        internal.oneagent.dynatrace.com/app: csi-driver
        internal.oneagent.dynatrace.com/component: csi-driver
    spec:
      serviceAccountName: dynatrace-oneagent-csi-driver
status:
 # TODO: this is not nice
  currentNumberScheduled: 3
  desiredNumberScheduled: 3
  numberAvailable: 3
  numberReady: 3
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dynatrace-webhook
  namespace: dynatrace
  labels:
    dynatrace.com/operator: dynakube
spec:
  replicas: 1
  revisionHistoryLimit: 1
  selector:
    matchLabels:
      internal.dynatrace.com/component: webhook
      internal.dynatrace.com/app: webhook
  strategy:
    type: RollingUpdate
  template:
    metadata:
      annotations:
        kubectl.kubernetes.io/default-container: webhook
      labels:
        dynatrace.com/operator: oneagent
        internal.dynatrace.com/component: webhook
        internal.dynatrace.com/app: webhook
    spec:
      serviceAccountName: dynatrace-webhook
status:
  availableReplicas: 1
  readyReplicas: 1
