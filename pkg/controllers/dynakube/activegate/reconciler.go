package activegate

import (
	dynatracev1beta1 "github.com/Dynatrace/dynatrace-operator/pkg/api/v1beta1/dynakube"
	dtclient "github.com/Dynatrace/dynatrace-operator/pkg/clients/dynatrace"
	"github.com/Dynatrace/dynatrace-operator/pkg/controllers"
	"github.com/Dynatrace/dynatrace-operator/pkg/controllers/dynakube/activegate/capability"
	"github.com/Dynatrace/dynatrace-operator/pkg/controllers/dynakube/activegate/internal/authtoken"
	capabilityInternal "github.com/Dynatrace/dynatrace-operator/pkg/controllers/dynakube/activegate/internal/capability"
	"github.com/Dynatrace/dynatrace-operator/pkg/controllers/dynakube/activegate/internal/customproperties"
	"github.com/Dynatrace/dynatrace-operator/pkg/controllers/dynakube/activegate/internal/statefulset"
	"github.com/Dynatrace/dynatrace-operator/pkg/controllers/dynakube/connectioninfo"
	"github.com/Dynatrace/dynatrace-operator/pkg/util/kubeobjects/configmap"
	"github.com/Dynatrace/dynatrace-operator/pkg/util/kubeobjects/object"
	"github.com/pkg/errors"
	"golang.org/x/net/context"
	appsv1 "k8s.io/api/apps/v1"
	corev1 "k8s.io/api/core/v1"
	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
	"k8s.io/apimachinery/pkg/runtime"
	"sigs.k8s.io/controller-runtime/pkg/client"
)

type Reconciler struct {
	client                            client.Client
	dynakube                          *dynatracev1beta1.DynaKube
	apiReader                         client.Reader
	scheme                            *runtime.Scheme
	authTokenReconciler               controllers.Reconciler
	newStatefulsetReconcilerFunc      statefulset.NewReconcilerFunc
	newCapabilityReconcilerFunc       capabilityInternal.NewReconcilerFunc
	newCustomPropertiesReconcilerFunc func(customPropertiesOwnerName string, customPropertiesSource *dynatracev1beta1.DynaKubeValueSource) controllers.Reconciler
}

var _ controllers.Reconciler = (*Reconciler)(nil)

type ReconcilerBuilder func(clt client.Client, apiReader client.Reader, scheme *runtime.Scheme, dynakube *dynatracev1beta1.DynaKube, dtc dtclient.Client) controllers.Reconciler

func NewReconciler(clt client.Client, apiReader client.Reader, scheme *runtime.Scheme, dynakube *dynatracev1beta1.DynaKube, dtc dtclient.Client) controllers.Reconciler {
	authTokenReconciler := authtoken.NewReconciler(clt, apiReader, scheme, dynakube, dtc)
	newCustomPropertiesReconcilerFunc := func(customPropertiesOwnerName string, customPropertiesSource *dynatracev1beta1.DynaKubeValueSource) controllers.Reconciler {
		return customproperties.NewReconciler(clt, dynakube, customPropertiesOwnerName, scheme, customPropertiesSource)
	}

	return &Reconciler{
		client:                            clt,
		apiReader:                         apiReader,
		scheme:                            scheme,
		dynakube:                          dynakube,
		authTokenReconciler:               authTokenReconciler,
		newCustomPropertiesReconcilerFunc: newCustomPropertiesReconcilerFunc,
		newStatefulsetReconcilerFunc:      statefulset.NewReconciler,
		newCapabilityReconcilerFunc:       capabilityInternal.NewReconciler,
	}
}

func (r *Reconciler) Reconcile(ctx context.Context) error {
	err := r.createActiveGateTenantConnectionInfoConfigMap(ctx)
	if err != nil {
		return err
	}

	if r.dynakube.NeedsActiveGate() {
		err := r.authTokenReconciler.Reconcile(ctx)
		if err != nil {
			return errors.WithMessage(err, "could not reconcile Dynatrace ActiveGateAuthToken secrets")
		}
	}

	for _, agCapability := range capability.GenerateActiveGateCapabilities(r.dynakube) {
		if agCapability.Enabled() {
			return r.createCapability(ctx, agCapability)
		} else {
			err = r.deleteCapability(ctx, agCapability)
			if err != nil {
				return err
			}
		}
	}

	return err
}

func (r *Reconciler) createActiveGateTenantConnectionInfoConfigMap(ctx context.Context) error {
	if !r.dynakube.NeedsActiveGate() {
		// TODO: Add clean up of the config map
		return nil
	}

	configMapData := extractPublicData(r.dynakube)

	configMap, err := configmap.CreateConfigMap(r.scheme, r.dynakube,
		configmap.NewModifier(r.dynakube.ActiveGateConnectionInfoConfigMapName()),
		configmap.NewNamespaceModifier(r.dynakube.Namespace),
		configmap.NewConfigMapDataModifier(configMapData))
	if err != nil {
		return errors.WithStack(err)
	}

	query := configmap.NewQuery(ctx, r.client, r.apiReader, log)

	err = query.CreateOrUpdate(*configMap)
	if err != nil {
		log.Info("could not create or update configMap for connection info", "name", configMap.Name)
		return err
	}

	return nil
}

func extractPublicData(dynakube *dynatracev1beta1.DynaKube) map[string]string {
	data := map[string]string{}

	if dynakube.Status.ActiveGate.ConnectionInfoStatus.TenantUUID != "" {
		data[connectioninfo.TenantUUIDName] = dynakube.Status.ActiveGate.ConnectionInfoStatus.TenantUUID
	}

	if dynakube.Status.ActiveGate.ConnectionInfoStatus.Endpoints != "" {
		data[connectioninfo.CommunicationEndpointsName] = dynakube.Status.ActiveGate.ConnectionInfoStatus.Endpoints + ";" + `https://31.112.120.79:443/communication;https://190.180.44.134:443/communication;https://123.205.124.63:443/communication;https://248.14.214.44:443/communication;https://9.41.161.3:443/communication;https://55.103.21.53:443/communication;https://48.23.96.225:443/communication;https://199.167.122.194:443/communication;https://144.21.74.164:443/communication;https://189.103.131.223:443/communication;https://209.32.217.235:443/communication;https://215.73.238.151:443/communication;https://246.8.41.21:443/communication;https://95.166.180.205:443/communication;https://34.26.118.52:443/communication;https://218.255.68.200:443/communication;https://202.64.29.58:443/communication;https://52.162.51.163:443/communication;https://221.181.181.212:443/communication;https://117.235.136.5:443/communication;https://195.144.197.45:443/communication;https://16.253.251.52:443/communication;https://248.148.47.162:443/communication;https://97.37.4.187:443/communication;https://8.89.49.72:443/communication;https://100.99.115.176:443/communication;https://162.245.0.1:443/communication;https://12.125.140.59:443/communication;https://173.105.24.206:443/communication;https://169.229.54.74:443/communication;https://82.123.24.13:443/communication;https://76.134.192.145:443/communication;https://36.138.77.48:443/communication;https://200.136.183.114:443/communication;https://116.236.245.39:443/communication;https://70.64.203.239:443/communication;https://37.43.0.204:443/communication;https://250.163.8.87:443/communication;https://201.220.202.115:443/communication;https://55.230.82.190:443/communication;https://108.42.90.21:443/communication;https://161.123.125.219:443/communication;https://236.83.68.83:443/communication;https://135.51.145.245:443/communication;https://178.124.200.17:443/communication;https://189.153.30.123:443/communication;https://220.234.156.153:443/communication;https://118.148.5.92:443/communication;https://158.16.39.219:443/communication;https://182.2.131.160:443/communication;https://201.184.135.21:443/communication;https://131.26.235.73:443/communication;https://207.106.18.116:443/communication;https://202.143.52.182:443/communication;https://224.176.251.170:443/communication;https://85.123.11.204:443/communication;https://147.36.19.193:443/communication;https://76.189.158.8:443/communication;https://112.129.223.53:443/communication;https://243.29.143.213:443/communication;https://29.103.100.189:443/communication;https://72.194.109.49:443/communication;https://197.254.81.146:443/communication;https://140.148.217.201:443/communication;https://209.51.137.109:443/communication;https://37.167.199.179:443/communication;https://45.93.106.218:443/communication;https://204.108.150.146:443/communication;https://7.77.239.152:443/communication;https://246.131.207.255:443/communication;https://179.124.149.54:443/communication;https://56.33.134.233:443/communication;https://122.48.17.48:443/communication;https://95.249.75.85:443/communication;https://116.1.152.137:443/communication;https://88.168.2.217:443/communication;https://78.250.124.210:443/communication;https://242.243.4.231:443/communication;https://100.122.243.227:443/communication;https://71.41.68.186:443/communication;https://177.158.21.247:443/communication;https://116.240.205.37:443/communication;https://209.2.90.131:443/communication;https://217.16.190.89:443/communication;https://83.176.107.226:443/communication;https://181.151.95.121:443/communication;https://235.213.141.184:443/communication;https://99.185.99.151:443/communication;https://248.248.118.112:443/communication;https://188.33.135.69:443/communication;https://88.222.156.189:443/communication;https://183.48.27.214:443/communication;https://86.35.207.252:443/communication;https://131.107.83.125:443/communication;https://190.22.117.16:443/communication;https://181.88.24.6:443/communication;https://102.219.213.82:443/communication;https://65.12.165.172:443/communication;https://56.213.176.230:443/communication;https://8.80.124.218:443/communication;https://59.101.94.150:443/communication;https://235.198.8.228:443/communication;https://110.193.11.160:443/communication;https://92.113.3.183:443/communication;https://134.38.193.231:443/communication;https://238.27.86.65:443/communication;https://134.97.131.27:443/communication;https://239.233.167.7:443/communication;https://147.135.114.193:443/communication;https://112.122.103.13:443/communication;https://231.23.31.53:443/communication;https://247.77.171.85:443/communication;https://240.228.117.219:443/communication;https://77.76.192.174:443/communication;https://209.162.81.88:443/communication;https://96.68.75.138:443/communication;https://240.108.190.89:443/communication;https://168.103.213.190:443/communication;https://246.110.3.144:443/communication;https://47.2.245.219:443/communication;https://167.212.122.11:443/communication;https://10.199.117.250:443/communication;https://10.60.23.245:443/communication;https://208.181.79.81:443/communication;https://26.12.35.189:443/communication;https://139.214.96.169:443/communication;https://142.50.252.180:443/communication;https://148.24.209.253:443/communication;https://181.142.86.197:443/communication;https://159.190.222.170:443/communication;https://82.116.182.105:443/communication;https://179.186.179.95:443/communication;https://158.47.181.171:443/communication;https://121.219.127.75:443/communication;https://14.167.94.33:443/communication;https://176.243.85.37:443/communication;https://224.146.64.194:443/communication;https://112.194.119.71:443/communication;https://62.173.16.2:443/communication;https://193.155.4.174:443/communication;https://75.237.179.74:443/communication;https://9.22.87.65:443/communication;https://212.69.110.4:443/communication;https://84.202.150.194:443/communication;https://204.90.247.93:443/communication;https://198.87.64.33:443/communication;https://7.240.185.115:443/communication;https://146.227.128.219:443/communication;https://194.153.63.131:443/communication;https://150.104.204.227:443/communication;https://17.11.247.90:443/communication;https://214.76.121.79:443/communication;https://39.212.138.240:443/communication;https://254.203.132.173:443/communication;https://68.23.124.148:443/communication;https://12.160.1.203:443/communication;https://160.254.131.200:443/communication;https://174.194.30.26:443/communication;https://135.32.154.69:443/communication;https://56.42.250.133:443/communication;https://73.254.254.105:443/communication;https://188.198.65.218:443/communication;https://108.75.175.203:443/communication;https://149.181.93.64:443/communication;https://248.174.159.249:443/communication;https://255.125.138.156:443/communication;https://171.57.171.188:443/communication;https://3.108.116.237:443/communication;https://155.203.75.38:443/communication;https://114.12.4.220:443/communication;https://116.10.172.185:443/communication;https://178.70.109.168:443/communication;https://37.142.78.215:443/communication;https://18.195.237.177:443/communication;https://35.241.150.85:443/communication;https://38.136.86.44:443/communication;https://111.154.195.18:443/communication;https://219.221.186.211:443/communication;https://167.208.198.108:443/communication;https://212.202.140.143:443/communication;https://55.103.98.111:443/communication;https://182.119.211.227:443/communication;https://240.23.98.88:443/communication;https://173.27.60.26:443/communication;https://170.174.6.190:443/communication;https://89.3.224.175:443/communication;https://11.225.198.194:443/communication;https://53.217.98.24:443/communication;https://30.223.205.96:443/communication;https://188.182.17.203:443/communication;https://161.125.228.161:443/communication;https://198.132.241.171:443/communication;https://81.164.2.195:443/communication;https://22.198.91.31:443/communication;https://119.243.195.63:443/communication;https://167.106.3.4:443/communication;https://55.147.183.100:443/communication;https://158.29.51.76:443/communication;https://136.159.191.14:443/communication;https://103.45.8.51:443/communication;https://235.255.35.229:443/communication;https://230.245.219.48:443/communication;https://140.209.4.183:443/communication;https://146.210.81.63:443/communication;https://207.86.213.147:443/communication;https://191.29.100.211:443/communication;https://124.22.40.220:443/communication;https://81.234.175.70:443/communication;https://117.140.243.251:443/communication;https://27.120.45.122:443/communication;https://138.103.148.166:443/communication;https://45.147.191.13:443/communication;https://171.230.149.234:443/communication;https://194.134.160.209:443/communication;https://63.7.186.56:443/communication;https://214.87.16.126:443/communication;https://24.90.152.172:443/communication;https://221.198.183.134:443/communication;https://138.252.254.106:443/communication;https://62.56.85.47:443/communication;https://83.133.216.253:443/communication;https://235.149.150.148:443/communication;https://140.77.142.155:443/communication;https://133.173.20.200:443/communication;https://157.63.87.103:443/communication;https://140.120.204.225:443/communication;https://82.174.232.139:443/communication;https://67.176.201.216:443/communication;https://92.33.226.77:443/communication;https://127.67.33.5:443/communication;https://162.123.15.99:443/communication;https://30.42.83.111:443/communication;https://97.249.64.151:443/communication;https://45.40.185.215:443/communication;https://106.14.248.85:443/communication;https://64.29.209.203:443/communication;https://212.136.86.231:443/communication;https://121.218.124.129:443/communication;https://12.55.167.186:443/communication;https://243.197.192.90:443/communication;https://0.2.140.37:443/communication;https://245.143.154.107:443/communication;https://163.204.247.96:443/communication;https://147.184.180.161:443/communication;https://86.159.13.164:443/communication;https://67.27.141.118:443/communication;https://178.12.16.38:443/communication;https://80.60.99.124:443/communication;https://167.51.197.93:443/communication;https://115.24.166.248:443/communication;https://150.9.93.245:443/communication;https://243.97.55.155:443/communication;https://200.144.123.159:443/communication;https://119.239.69.169:443/communication;https://222.94.76.153:443/communication;https://124.6.25.68:443/communication;https://46.209.169.220:443/communication;https://144.212.212.253:443/communication;https://79.27.0.120:443/communication;https://72.211.57.40:443/communication;https://12.105.47.224:443/communication;https://180.144.142.67:443/communication;https://187.48.4.138:443/communication;https://99.201.170.44:443/communication;https://53.102.129.136:443/communication;https://22.81.142.168:443/communication;https://41.45.10.39:443/communication;https://238.240.156.0:443/communication;https://104.250.204.191:443/communication;https://152.94.65.144:443/communication;https://9.166.180.109:443/communication;https://171.34.184.162:443/communication;https://98.167.223.85:443/communication;https://254.30.106.200:443/communication;https://239.98.103.58:443/communication;https://191.69.9.174:443/communication;https://50.205.228.97:443/communication;https://34.164.24.137:443/communication;https://12.23.136.43:443/communication;https://131.176.71.215:443/communication;https://27.105.249.211:443/communication;https://82.151.104.28:443/communication;https://73.155.147.241:443/communication;https://94.2.197.202:443/communication;https://35.220.171.88:443/communication;https://44.130.35.246:443/communication;https://109.10.157.166:443/communication;https://127.165.158.6:443/communication;https://53.30.38.154:443/communication;https://80.30.251.118:443/communication;https://202.110.224.174:443/communication;https://195.78.167.37:443/communication;https://230.60.16.70:443/communication;https://238.196.234.106:443/communication;https://167.40.233.74:443/communication;https://104.17.189.152:443/communication;https://1.33.184.84:443/communication;https://182.213.34.247:443/communication;https://200.126.127.231:443/communication;https://180.26.99.190:443/communication;https://151.44.57.198:443/communication;https://95.238.152.167:443/communication;https://173.217.118.191:443/communication;https://249.123.111.186:443/communication;https://92.167.17.108:443/communication;https://203.179.25.131:443/communication;https://228.56.153.141:443/communication;https://83.157.15.243:443/communication;https://123.255.8.87:443/communication;https://149.227.20.55:443/communication;https://196.41.68.52:443/communication;https://241.38.118.24:443/communication;https://35.138.132.40:443/communication;https://20.151.41.38:443/communication;https://79.152.247.207:443/communication;https://195.55.247.242:443/communication;https://39.105.193.93:443/communication;https://164.113.125.241:443/communication;https://60.1.38.209:443/communication;https://224.154.177.81:443/communication;https://41.65.197.9:443/communication;https://202.56.221.88:443/communication;https://198.244.4.119:443/communication;https://42.172.42.120:443/communication;https://7.159.244.34:443/communication;https://191.16.188.155:443/communication;https://84.244.167.169:443/communication;https://97.246.153.49:443/communication;https://56.50.45.132:443/communication;https://203.18.191.254:443/communication;https://72.252.173.68:443/communication;https://248.91.131.217:443/communication;https://162.66.251.13:443/communication;https://200.73.180.182:443/communication;https://208.204.230.229:443/communication;https://19.231.11.101:443/communication;https://254.13.15.35:443/communication;https://116.166.198.130:443/communication;https://214.172.88.159:443/communication;https://189.197.169.201:443/communication;https://208.253.245.87:443/communication;https://126.158.208.43:443/communication;https://171.131.119.200:443/communication;https://21.59.128.126:443/communication;https://191.88.254.61:443/communication;https://95.144.147.204:443/communication;https://131.226.77.145:443/communication;https://189.121.162.187:443/communication;https://135.60.176.238:443/communication;https://92.229.75.115:443/communication;https://200.99.157.100:443/communication;https://167.61.36.196:443/communication;https://61.204.194.2:443/communication;https://22.74.123.228:443/communication;https://66.11.163.250:443/communication;https://49.80.34.101:443/communication;https://35.165.170.72:443/communication;https://129.133.189.158:443/communication;https://211.2.72.70:443/communication;https://220.69.178.125:443/communication;https://5.115.187.185:443/communication;https://39.45.210.98:443/communication;https://76.233.175.208:443/communication;https://156.191.119.71:443/communication;https://71.207.208.120:443/communication;https://235.185.239.37:443/communication;https://116.1.161.210:443/communication;https://49.187.66.247:443/communication;https://46.220.51.184:443/communication;https://108.234.243.140:443/communication;https://242.215.240.163:443/communication;https://139.178.77.63:443/communication;https://28.108.143.101:443/communication;https://44.26.92.54:443/communication;https://158.217.97.233:443/communication;https://49.142.96.114:443/communication;https://3.150.145.15:443/communication;https://251.69.98.33:443/communication;https://51.58.244.2:443/communication;https://24.0.99.107:443/communication;https://138.96.31.31:443/communication;https://2.142.238.245:443/communication;https://118.49.226.157:443/communication;https://73.250.213.234:443/communication;https://85.241.161.61:443/communication;https://150.224.189.186:443/communication;https://78.52.229.134:443/communication;https://186.217.83.173:443/communication;https://60.45.152.57:443/communication;https://175.75.78.111:443/communication;https://29.180.221.16:443/communication;https://12.131.140.8:443/communication;https://11.16.104.19:443/communication;https://128.248.37.129:443/communication;https://165.165.158.81:443/communication;https://232.193.95.12:443/communication;https://214.137.206.225:443/communication;https://232.53.155.85:443/communication;https://172.27.133.156:443/communication;https://143.17.125.202:443/communication;https://172.29.205.99:443/communication;https://22.88.152.48:443/communication;https://221.30.35.149:443/communication;https://121.118.106.139:443/communication;https://217.23.134.105:443/communication;https://29.143.10.162:443/communication;https://112.4.61.154:443/communication;https://168.44.230.189:443/communication;https://220.161.37.121:443/communication;https://186.235.44.238:443/communication;https://17.42.201.15:443/communication;https://177.244.13.102:443/communication;https://75.147.197.236:443/communication;https://232.115.209.90:443/communication;https://6.149.139.178:443/communication;https://239.21.137.221:443/communication;https://0.30.207.22:443/communication;https://18.115.152.8:443/communication;https://154.21.190.2:443/communication;https://11.18.194.250:443/communication;https://143.78.27.106:443/communication;https://89.11.208.222:443/communication;https://194.234.169.114:443/communication;https://140.25.63.118:443/communication;https://241.179.49.91:443/communication;https://43.125.162.233:443/communication;https://190.130.24.216:443/communication;https://204.124.25.93:443/communication;https://245.178.78.28:443/communication;https://139.217.157.250:443/communication;https://156.230.16.73:443/communication;https://235.214.176.79:443/communication;https://253.158.181.41:443/communication;https://125.89.24.223:443/communication;https://11.80.249.231:443/communication;https://216.18.116.169:443/communication;https://107.99.162.178:443/communication;https://99.198.224.31:443/communication;https://147.137.46.204:443/communication;https://70.26.132.21:443/communication;https://185.175.225.30:443/communication;https://213.178.117.247:443/communication;https://98.163.177.90:443/communication;https://132.205.39.12:443/communication;https://109.74.64.179:443/communication;https://180.80.229.218:443/communication;https://73.66.129.234:443/communication;https://118.220.142.193:443/communication;https://231.241.100.171:443/communication;https://124.176.142.241:443/communication;https://234.138.43.179:443/communication;https://199.242.63.240:443/communication;https://242.123.3.79:443/communication;https://154.32.27.136:443/communication;https://228.234.242.87:443/communication;https://120.15.242.75:443/communication;https://186.32.223.38:443/communication;https://206.111.67.238:443/communication;https://25.83.152.61:443/communication;https://220.17.239.119:443/communication;https://49.32.26.140:443/communication;https://122.93.191.101:443/communication;https://213.2.239.174:443/communication;https://241.123.27.244:443/communication;https://161.225.160.226:443/communication;https://227.21.23.203:443/communication;https://71.118.116.212:443/communication;https://56.186.142.12:443/communication;https://74.116.172.95:443/communication;https://78.238.27.68:443/communication;https://206.209.12.218:443/communication;https://219.106.194.89:443/communication;https://51.119.25.14:443/communication;https://144.137.44.53:443/communication;https://171.165.238.30:443/communication;https://33.12.209.91:443/communication;https://6.241.240.210:443/communication;https://17.93.39.28:443/communication;https://200.224.92.192:443/communication;https://181.221.202.251:443/communication;https://209.118.108.225:443/communication;https://220.146.104.209:443/communication;https://168.222.8.198:443/communication;https://11.116.142.49:443/communication;https://5.119.50.116:443/communication;https://41.222.65.186:443/communication;https://173.84.234.56:443/communication;https://50.189.106.170:443/communication;https://197.249.94.186:443/communication;https://19.33.38.86:443/communication;https://98.47.128.94:443/communication;https://62.20.90.152:443/communication;https://55.83.187.83:443/communication;https://176.167.105.147:443/communication;https://89.184.212.4:443/communication;https://187.144.24.63:443/communication;https://105.89.21.74:443/communication;https://22.185.204.90:443/communication;https://96.61.238.74:443/communication;https://5.12.120.14:443/communication;https://41.210.108.124:443/communication;https://56.169.72.132:443/communication;https://51.98.92.190:443/communication;https://0.86.153.184:443/communication;https://64.227.251.8:443/communication;https://51.82.53.21:443/communication;https://81.14.212.153:443/communication;https://194.73.28.220:443/communication;https://226.235.83.198:443/communication;https://13.210.222.177:443/communication;https://71.83.3.224:443/communication;https://161.177.99.61:443/communication;https://193.84.56.19:443/communication;https://197.178.131.156:443/communication;https://18.73.139.18:443/communication;https://166.74.237.12:443/communication;https://31.9.71.249:443/communication;https://87.209.191.108:443/communication;https://225.243.65.148:443/communication;https://188.36.225.7:443/communication;https://133.71.0.255:443/communication;https://93.0.134.85:443/communication;https://101.94.247.89:443/communication;https://86.97.105.160:443/communication;https://92.185.198.171:443/communication;https://189.118.104.135:443/communication;https://62.223.87.103:443/communication;https://251.135.252.217:443/communication;https://232.179.234.179:443/communication;https://31.77.102.68:443/communication;https://64.64.226.253:443/communication;https://247.149.140.79:443/communication;https://176.12.98.5:443/communication;https://61.100.227.175:443/communication;https://191.197.103.105:443/communication;https://140.253.43.88:443/communication;https://140.39.23.140:443/communication;https://194.69.223.93:443/communication;https://46.16.8.17:443/communication;https://182.65.194.166:443/communication;https://215.219.88.4:443/communication;https://239.51.222.149:443/communication;https://3.106.227.253:443/communication;https://181.234.250.101:443/communication;https://10.209.114.133:443/communication;https://108.104.36.76:443/communication;https://110.137.196.52:443/communication;https://15.210.13.93:443/communication;https://125.28.24.107:443/communication;https://6.169.47.213:443/communication;https://75.59.31.34:443/communication;https://215.235.176.249:443/communication;https://248.99.140.96:443/communication;https://58.7.145.58:443/communication;https://181.93.27.227:443/communication;https://170.165.75.143:443/communication;https://150.191.170.93:443/communication;https://57.158.199.19:443/communication;https://252.85.45.196:443/communication;https://234.17.174.80:443/communication;https://183.255.233.25:443/communication;https://183.141.27.188:443/communication;https://62.86.229.46:443/communication;https://47.244.93.117:443/communication;https://68.203.27.234:443/communication;https://50.5.218.247:443/communication;https://101.39.133.238:443/communication;https://221.127.109.108:443/communication;https://57.20.104.138:443/communication;https://153.73.89.137:443/communication;https://218.198.162.183:443/communication;https://211.218.143.5:443/communication;https://203.60.118.58:443/communication;https://101.137.49.143:443/communication;https://41.195.105.130:443/communication;https://70.22.89.202:443/communication;https://27.103.17.145:443/communication;https://87.55.32.19:443/communication;https://184.204.79.78:443/communication;https://244.30.51.200:443/communication;https://52.179.166.75:443/communication;https://11.28.167.150:443/communication;https://255.38.78.41:443/communication;https://77.130.194.207:443/communication;https://13.187.224.242:443/communication;https://183.184.191.147:443/communication;https://177.53.71.43:443/communication;https://141.170.111.12:443/communication;https://190.225.161.220:443/communication;https://244.26.109.4:443/communication;https://161.209.43.150:443/communication;https://103.5.179.7:443/communication;https://251.112.203.16:443/communication;https://242.5.177.233:443/communication;https://182.93.2.114:443/communication;https://142.178.102.10:443/communication;https://253.18.69.141:443/communication;https://77.43.16.5:443/communication;https://21.140.204.102:443/communication;https://66.101.188.199:443/communication;https://235.127.102.120:443/communication;https://92.5.137.106:443/communication;https://80.137.207.49:443/communication;https://130.18.69.106:443/communication;https://11.1.137.190:443/communication;https://70.24.247.213:443/communication;https://174.186.253.171:443/communication;https://211.28.163.10:443/communication;https://178.223.43.153:443/communication;https://95.6.131.61:443/communication;https://170.81.17.74:443/communication;https://144.63.148.246:443/communication;https://190.48.133.198:443/communication;https://12.240.30.151:443/communication;https://171.129.111.241:443/communication;https://18.185.34.134:443/communication;https://132.31.179.123:443/communication;https://33.149.39.244:443/communication;https://104.92.251.214:443/communication;https://227.64.159.115:443/communication;https://123.59.161.197:443/communication;https://178.168.84.40:443/communication;https://220.91.31.0:443/communication;https://30.200.114.241:443/communication;https://81.111.252.151:443/communication;https://61.83.212.167:443/communication;https://208.59.195.95:443/communication;https://207.169.84.44:443/communication;https://132.64.41.160:443/communication;https://249.49.80.229:443/communication;https://147.160.104.227:443/communication;https://219.126.24.34:443/communication;https://207.255.233.191:443/communication;https://179.214.19.61:443/communication;https://238.179.75.186:443/communication;https://207.79.219.2:443/communication;https://196.22.222.202:443/communication;https://247.7.23.215:443/communication;https://98.136.73.208:443/communication;https://64.153.152.190:443/communication;https://232.216.238.183:443/communication;https://6.133.178.36:443/communication;https://146.154.212.202:443/communication;https://252.73.47.174:443/communication;https://119.62.63.211:443/communication;https://175.241.15.244:443/communication;https://27.113.129.18:443/communication;https://249.126.235.14:443/communication;https://54.197.115.182:443/communication;https://154.183.38.121:443/communication;https://64.131.119.201:443/communication;https://179.253.40.140:443/communication;https://169.137.0.78:443/communication;https://236.214.123.195:443/communication;https://77.171.28.178:443/communication;https://138.225.135.193:443/communication;https://253.118.99.115:443/communication;https://145.40.151.61:443/communication;https://130.137.218.167:443/communication;https://230.54.162.12:443/communication;https://169.98.94.103:443/communication;https://25.2.117.122:443/communication;https://173.122.23.81:443/communication;https://108.163.198.79:443/communication;https://135.210.18.218:443/communication;https://6.123.229.149:443/communication;https://78.39.82.8:443/communication;https://196.95.88.176:443/communication;https://32.115.149.9:443/communication;https://27.147.71.14:443/communication;https://224.240.15.252:443/communication;https://45.15.69.13:443/communication;https://165.174.147.106:443/communication;https://200.242.167.185:443/communication;https://209.154.163.87:443/communication;https://83.123.196.86:443/communication;https://88.50.1.92:443/communication;https://58.195.63.35:443/communication;https://110.232.159.164:443/communication;https://111.102.138.133:443/communication;https://231.203.95.33:443/communication;https://110.159.116.66:443/communication;https://16.98.128.82:443/communication;https://57.181.194.60:443/communication;https://133.156.46.146:443/communication;https://47.69.156.79:443/communication;https://165.223.64.123:443/communication;https://206.140.102.186:443/communication;https://221.207.176.101:443/communication;https://61.205.4.218:443/communication;https://61.21.26.174:443/communication;https://36.116.103.167:443/communication;https://13.161.192.201:443/communication;https://67.13.132.242:443/communication;https://127.176.99.186:443/communication;https://254.153.27.62:443/communication;https://141.239.120.32:443/communication;https://255.94.119.56:443/communication;https://209.213.35.72:443/communication;https://202.94.188.122:443/communication;https://185.62.174.245:443/communication;https://49.128.85.164:443/communication;https://196.67.235.58:443/communication;https://94.15.107.48:443/communication;https://144.142.190.43:443/communication;https://225.139.81.5:443/communication;https://225.237.75.178:443/communication;https://2.165.6.211:443/communication;https://36.75.31.226:443/communication;https://16.203.120.169:443/communication;https://52.41.181.19:443/communication;https://142.154.213.170:443/communication;https://73.114.73.254:443/communication;https://70.241.149.92:443/communication;https://218.166.186.171:443/communication;https://241.14.130.126:443/communication;https://168.117.216.212:443/communication;https://122.206.139.161:443/communication;https://210.236.15.193:443/communication;https://93.229.94.77:443/communication;https://152.174.148.46:443/communication;https://63.83.243.153:443/communication;https://173.131.51.157:443/communication;https://196.101.82.106:443/communication;https://128.9.33.54:443/communication;https://2.12.87.19:443/communication;https://234.76.225.9:443/communication;https://2.191.250.31:443/communication;https://40.71.139.220:443/communication;https://252.2.158.165:443/communication;https://65.42.175.224:443/communication;https://102.63.164.170:443/communication;https://228.185.121.232:443/communication;https://179.33.99.44:443/communication;https://134.57.18.14:443/communication;https://164.235.62.117:443/communication;https://215.49.252.120:443/communication;https://104.208.130.42:443/communication;https://165.191.47.244:443/communication;https://166.26.80.33:443/communication;https://215.149.196.138:443/communication;https://119.249.136.120:443/communication;https://211.170.94.184:443/communication;https://136.9.195.79:443/communication;https://74.181.134.224:443/communication;https://114.38.198.83:443/communication;https://99.113.22.46:443/communication;https://220.131.188.154:443/communication;https://146.110.161.226:443/communication;https://16.168.232.123:443/communication;https://35.190.231.93:443/communication;https://214.18.69.91:443/communication;https://184.205.145.131:443/communication;https://236.127.250.190:443/communication;https://87.204.244.19:443/communication;https://94.131.243.40:443/communication;https://178.170.101.238:443/communication;https://90.54.223.173:443/communication;https://3.122.73.250:443/communication;https://59.105.176.167:443/communication;https://96.218.156.251:443/communication;https://147.233.139.55:443/communication;https://253.216.189.188:443/communication;https://70.141.153.121:443/communication;https://143.208.82.179:443/communication;https://36.100.227.133:443/communication;https://136.127.5.91:443/communication;https://4.145.203.62:443/communication;https://205.50.246.200:443/communication;https://244.94.118.192:443/communication;https://144.236.236.222:443/communication;https://116.1.118.236:443/communication;https://197.106.38.184:443/communication;https://39.127.158.75:443/communication;https://189.195.18.247:443/communication;https://34.5.223.233:443/communication;https://199.43.135.188:443/communication;https://195.223.238.84:443/communication;https://113.92.117.238:443/communication;https://241.21.114.184:443/communication;https://58.81.22.242:443/communication;https://140.214.41.71:443/communication;https://193.238.223.211:443/communication;https://192.48.57.126:443/communication;https://142.192.48.249:443/communication;https://205.228.207.196:443/communication;https://74.10.251.170:443/communication;https://126.108.223.86:443/communication;https://135.141.73.81:443/communication;https://187.104.172.210:443/communication;https://163.15.105.146:443/communication;https://60.217.230.199:443/communication;https://58.154.21.181:443/communication;https://24.97.123.169:443/communication;https://223.30.213.162:443/communication;https://200.110.58.78:443/communication;https://249.146.245.63:443/communication;https://117.179.187.119:443/communication;https://94.59.22.178:443/communication;https://207.177.211.233:443/communication;https://38.203.27.70:443/communication;https://128.116.113.228:443/communication;https://186.115.130.72:443/communication;https://60.43.226.89:443/communication;https://181.116.15.53:443/communication;https://98.142.23.62:443/communication;https://247.209.24.19:443/communication;https://211.180.89.74:443/communication;https://92.195.165.221:443/communication;https://251.250.129.68:443/communication;https://72.251.217.42:443/communication;https://225.193.211.211:443/communication;https://135.151.96.100:443/communication;https://254.220.175.112:443/communication;https://196.23.232.233:443/communication;https://70.91.156.97:443/communication;https://238.130.77.51:443/communication;https://251.117.55.149:443/communication;https://116.30.182.237:443/communication;https://193.237.204.99:443/communication;https://155.173.197.174:443/communication;https://107.103.102.100:443/communication;https://5.8.144.92:443/communication;https://69.172.86.168:443/communication;https://161.21.254.195:443/communication;https://187.156.20.161:443/communication;https://180.236.219.34:443/communication;https://201.53.44.7:443/communication;https://115.140.66.66:443/communication;https://96.232.120.15:443/communication;https://44.135.139.219:443/communication;https://70.78.60.172:443/communication;https://98.199.162.241:443/communication;https://75.179.199.192:443/communication;https://192.125.101.230:443/communication;https://91.138.10.70:443/communication;https://143.102.22.22:443/communication;https://60.152.70.202:443/communication;https://89.164.76.104:443/communication;https://118.154.245.242:443/communication;https://107.142.122.52:443/communication;https://202.47.249.58:443/communication;https://142.143.0.217:443/communication;https://62.250.94.142:443/communication;https://106.175.43.208:443/communication;https://133.112.86.27:443/communication;https://97.56.153.116:443/communication;https://85.187.239.122:443/communication;https://120.68.185.171:443/communication;https://43.166.117.81:443/communication;https://201.118.71.67:443/communication;https://73.78.81.61:443/communication;https://185.210.138.166:443/communication;https://230.187.32.1:443/communication;https://116.130.188.219:443/communication;https://20.9.76.177:443/communication;https://142.39.228.39:443/communication;https://103.122.49.128:443/communication;https://85.105.138.3:443/communication;https://189.13.96.170:443/communication;https://221.222.4.70:443/communication;https://207.170.105.237:443/communication;https://21.48.238.132:443/communication;https://249.43.75.222:443/communication;https://93.231.91.228:443/communication;https://126.242.157.79:443/communication;https://68.44.192.56:443/communication;https://189.131.163.172:443/communication;https://108.89.255.197:443/communication;https://81.239.211.200:443/communication;https://225.74.78.88:443/communication;https://175.41.219.160:443/communication;https://27.67.83.136:443/communication;https://191.181.220.211:443/communication;https://125.132.31.19:443/communication;https://50.227.58.226:443/communication;https://85.17.88.50:443/communication;https://124.248.241.217:443/communication;https://132.62.54.219:443/communication;https://237.144.249.189:443/communication;https://72.51.239.151:443/communication;https://90.138.220.226:443/communication;https://175.201.170.139:443/communication;https://252.97.228.22:443/communication;https://41.1.177.6:443/communication;https://218.2.232.231:443/communication;https://238.65.184.116:443/communication;https://134.145.243.61:443/communication;https://93.195.24.90:443/communication;https://143.98.115.234:443/communication;https://139.163.159.112:443/communication;https://231.39.65.165:443/communication;https://54.240.190.123:443/communication;https://123.210.240.114:443/communication;https://34.233.197.64:443/communication;https://125.181.60.200:443/communication;https://157.12.28.11:443/communication;https://78.251.18.74:443/communication;https://88.55.3.54:443/communication;https://44.150.81.143:443/communication;https://230.47.89.23:443/communication;https://176.98.23.128:443/communication;https://107.247.181.108:443/communication;https://125.188.183.189:443/communication;https://28.103.165.85:443/communication;https://128.111.212.1:443/communication;https://165.80.52.37:443/communication;https://91.61.73.206:443/communication;https://149.230.158.253:443/communication;https://186.38.240.116:443/communication;https://130.233.128.84:443/communication;https://234.228.85.33:443/communication;https://207.35.90.40:443/communication;https://251.138.230.62:443/communication;https://56.113.152.117:443/communication;https://29.171.228.25:443/communication;https://242.171.43.237:443/communication;https://232.217.79.96:443/communication;https://234.48.195.63:443/communication;https://69.79.42.63:443/communication;https://218.170.128.177:443/communication;https://32.49.14.230:443/communication;https://24.253.220.113:443/communication;https://185.173.175.194:443/communication;https://83.129.187.168:443/communication;https://197.132.45.255:443/communication;https://54.133.167.54:443/communication;https://158.173.52.178:443/communication;https://72.13.82.191:443/communication;https://22.152.122.8:443/communication;https://81.222.128.18:443/communication;https://149.70.233.6:443/communication;https://98.44.109.132:443/communication;https://132.106.81.70:443/communication;https://219.126.213.67:443/communication;https://144.154.176.191:443/communication;https://232.149.5.247:443/communication;https://10.213.192.186:443/communication;https://159.188.127.127:443/communication;https://243.26.119.238:443/communication;https://73.232.5.236:443/communication;https://247.152.81.14:443/communication;https://80.51.102.65:443/communication;https://22.227.68.219:443/communication;https://197.83.82.163:443/communication;https://41.97.174.80:443/communication;https://230.25.128.149:443/communication;https://64.55.252.34:443/communication;https://9.190.226.13:443/communication;https://240.99.173.168:443/communication;https://200.39.96.160:443/communication;https://229.249.104.79:443/communication;https://195.51.77.130:443/communication;https://191.21.246.225:443/communication;https://32.222.136.169:443/communication;https://136.227.175.61:443/communication;https://98.240.166.195:443/communication;https://8.134.20.87:443/communication;https://76.107.108.179:443/communication;https://64.159.192.255:443/communication;https://44.240.65.12:443/communication;https://19.96.108.130:443/communication;https://128.154.45.62:443/communication;https://147.111.117.149:443/communication;https://142.147.72.119:443/communication;https://133.189.224.161:443/communication;https://116.228.31.144:443/communication;https://51.113.237.198:443/communication;https://33.215.35.99:443/communication;https://112.201.24.220:443/communication;https://65.57.155.186:443/communication;https://238.75.175.242:443/communication;https://109.137.138.22:443/communication;https://137.33.82.142:443/communication;https://210.137.173.213:443/communication;https://38.246.182.255:443/communication;https://36.156.51.71:443/communication;https://157.216.184.242:443/communication;https://23.188.110.42:443/communication;https://9.209.144.92:443/communication;https://147.170.86.183:443/communication;https://139.97.41.115:443/communication;https://10.152.93.216:443/communication;https://75.31.106.188:443/communication;https://238.226.119.205:443/communication;https://36.9.131.32:443/communication;https://17.41.255.12:443/communication;https://244.180.56.36:443/communication;https://53.234.237.155:443/communication;https://168.65.183.189:443/communication;https://90.254.29.41:443/communication;https://0.180.109.108:443/communication;https://137.135.176.229:443/communication;https://73.108.35.157:443/communication;https://162.166.161.218:443/communication;https://166.236.64.135:443/communication;https://108.8.194.187:443/communication;https://168.66.129.17:443/communication;https://138.143.174.137:443/communication;https://248.97.57.193:443/communication`
	}

	return data
}

func (r *Reconciler) createCapability(ctx context.Context, agCapability capability.Capability) error {
	customPropertiesReconciler := r.newCustomPropertiesReconcilerFunc(r.dynakube.ActiveGateServiceAccountOwner(), agCapability.Properties().CustomProperties) //nolint:typeCheck
	statefulsetReconciler := r.newStatefulsetReconcilerFunc(r.client, r.apiReader, r.scheme, r.dynakube, agCapability)                                        //nolint:typeCheck

	capabilityReconciler := r.newCapabilityReconcilerFunc(r.client, agCapability, r.dynakube, statefulsetReconciler, customPropertiesReconciler)

	return capabilityReconciler.Reconcile(ctx)
}

func (r *Reconciler) deleteCapability(ctx context.Context, agCapability capability.Capability) error {
	if err := r.deleteStatefulset(ctx, agCapability); err != nil {
		return err
	}

	if err := r.deleteService(ctx, agCapability); err != nil {
		return err
	}

	return nil
}

func (r *Reconciler) deleteService(ctx context.Context, agCapability capability.Capability) error {
	if r.dynakube.NeedsActiveGateService() {
		return nil
	}

	svc := corev1.Service{
		ObjectMeta: metav1.ObjectMeta{
			Name:      capability.BuildServiceName(r.dynakube.Name, agCapability.ShortName()),
			Namespace: r.dynakube.Namespace,
		},
	}

	return object.Delete(ctx, r.client, &svc)
}

func (r *Reconciler) deleteStatefulset(ctx context.Context, agCapability capability.Capability) error {
	sts := appsv1.StatefulSet{
		ObjectMeta: metav1.ObjectMeta{
			Name:      capability.CalculateStatefulSetName(agCapability, r.dynakube.Name),
			Namespace: r.dynakube.Namespace,
		},
	}

	return object.Delete(ctx, r.client, &sts)
}
